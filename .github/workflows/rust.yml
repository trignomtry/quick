name: Rust

on:
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always
  LLVM_TAG: llvmorg-18.1.4
  ZSTD_VERSION: 1.5.6
  DEPS_PREFIX: ${{ github.workspace }}/deps/install

jobs:
  build:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            runner: ubuntu-22.04
            os_id: linux
            arch: x86_64
            target: x86_64-unknown-linux-gnu
            bin_ext: ""
            package: tar
            rustflags: ""
          - name: macos-arm64
            runner: macos-14
            os_id: darwin
            arch: arm64
            target: aarch64-apple-darwin
            bin_ext: ""
            package: tar
            rustflags: ""
          - name: macos-x86_64
            runner: macos-14
            os_id: darwin
            arch: x86_64
            target: x86_64-apple-darwin
            bin_ext: ""
            package: tar
            rustflags: ""
          - name: windows-x86_64
            runner: windows-latest
            os_id: windows
            arch: x86_64
            target: x86_64-pc-windows-msvc
            bin_ext: ".exe"
            package: zip
            rustflags: ""

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine version
        id: version
        run: |
          set -euo pipefail
          VERSION=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[] | select(.name=="quick") | .version')
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Install Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: nightly
          targets: ${{ matrix.target }}

      - name: Free disk space (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo rm -rf /usr/share/dotnet /opt/ghc /opt/hostedtoolcache/CodeQL || true
          sudo rm -rf /opt/hostedtoolcache/go /opt/hostedtoolcache/Python /opt/hostedtoolcache/Ruby || true
          sudo rm -rf /opt/google/chrome /usr/local/lib/android /usr/local/share/boost /home/linuxbrew || true
          docker system prune -af || true
          df -h

      - name: Install build dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential musl-tools zstd libzstd-dev xz-utils pkg-config libtinfo5 libncurses5 ninja-build

      - name: Enable Rosetta for x86 build (macOS)
        if: runner.os == 'macOS' && matrix.arch == 'x86_64'
        run: softwareupdate --install-rosetta --agree-to-license

      - name: Build zstd from source (static)
        if: runner.os != 'Windows'
        run: |
          set -euo pipefail
          mkdir -p "${DEPS_PREFIX}"
          curl -fsSL -o /tmp/zstd.tar.gz "https://github.com/facebook/zstd/releases/download/v${ZSTD_VERSION}/zstd-${ZSTD_VERSION}.tar.gz"
          tar xzf /tmp/zstd.tar.gz -C /tmp
          cmake -S "/tmp/zstd-${ZSTD_VERSION}/build/cmake" -B /tmp/zstd-build \
            -DZSTD_BUILD_SHARED=OFF -DZSTD_BUILD_STATIC=ON -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${DEPS_PREFIX}"
          cmake --build /tmp/zstd-build --config Release --target install

      - name: Build LLVM + libunwind from source (static)
        if: runner.os != 'Windows'
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${LLVM_TAG}" https://github.com/llvm/llvm-project.git /tmp/llvm-project
          cmake -G Ninja -S /tmp/llvm-project/llvm -B /tmp/llvm-build \
            -DLLVM_TARGETS_TO_BUILD="X86;AArch64" \
            -DLLVM_ENABLE_PROJECTS="clang;lld" \
            -DLLVM_ENABLE_RUNTIMES="libunwind" \
            -DLLVM_BUILD_LLVM_DYLIB=OFF -DLLVM_LINK_LLVM_DYLIB=OFF \
            -DBUILD_SHARED_LIBS=OFF -DLLVM_ENABLE_TERMINFO=OFF -DLLVM_ENABLE_LIBXML2=OFF \
            -DLLVM_ENABLE_ZSTD=OFF -DLLVM_ENABLE_ZLIB=OFF \
            -DLIBUNWIND_ENABLE_SHARED=OFF -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX="${DEPS_PREFIX}"
          cmake --build /tmp/llvm-build --config Release --target install
          echo "${DEPS_PREFIX}/bin" >> "$GITHUB_PATH"

      - name: Install LLVM (Windows)
        if: matrix.os_id == 'windows'
        shell: pwsh
        env:
          LLVM_PREFIX: ${{ github.workspace }}/llvm/install
          LLVM_TAG: ${{ env.LLVM_TAG }}
        run: |
          & scripts/vendor_llvm.ps1

      - name: Install libxml2 (Windows)
        if: matrix.os_id == 'windows'
        shell: pwsh
        run: |
          choco install -y libxml2

      - name: Build release
        env:
          LLVM_PREFIX: ${{ runner.os == 'Windows' && format('{0}/llvm/install', github.workspace) || env.DEPS_PREFIX }}
          LLVM_SYS_181_PREFIX: ${{ runner.os == 'Windows' && format('{0}/llvm/install', github.workspace) || env.DEPS_PREFIX }}
          LLVM_CONFIG_PATH: ${{ runner.os == 'Windows' && format('{0}/llvm/install/bin/llvm-config.exe', github.workspace) || format('{0}/bin/llvm-config', env.DEPS_PREFIX) }}
          LIBRARY_PATH: ${{ runner.os == 'Windows' && format('{0}/llvm/install/lib', github.workspace) || format('{0}/lib', env.DEPS_PREFIX) }}
          LD_LIBRARY_PATH: ${{ runner.os == 'Windows' && format('{0}/llvm/install/lib', github.workspace) || format('{0}/lib', env.DEPS_PREFIX) }}
          DYLD_LIBRARY_PATH: ${{ runner.os == 'Windows' && format('{0}/llvm/install/lib', github.workspace) || format('{0}/lib', env.DEPS_PREFIX) }}
          RUSTFLAGS: ${{ matrix.rustflags }}
          CARGO_TARGET_DIR: ${{ github.workspace }}/target
        run: |
          cargo build --locked --release --target ${{ matrix.target }}

      - name: Package artifact (Linux/macOS)
        if: matrix.os_id != 'windows'
        id: package-unix
        run: |
          set -euo pipefail
          ARTIFACT_BASE="quick-${{ matrix.os_id }}-${{ matrix.arch }}"
          TARGET_DIR="target/${{ matrix.target }}/release"
          BIN_SRC="${TARGET_DIR}/quick${{ matrix.bin_ext }}"
          OUT_DIR="${GITHUB_WORKSPACE}/dist/${{ matrix.name }}"
          mkdir -p "${OUT_DIR}"
          cp "${BIN_SRC}" "${OUT_DIR}/${ARTIFACT_BASE}${{ matrix.bin_ext }}"

          LIB_SRC=""
          if compgen -G "${TARGET_DIR}/libquick.*" > /dev/null; then
            LIB_SRC=$(ls "${TARGET_DIR}/libquick."* | head -n1)
          elif compgen -G "${TARGET_DIR}/quick.*" > /dev/null; then
            LIB_SRC=$(ls "${TARGET_DIR}/quick."* | head -n1)
          fi

          if [ -n "${LIB_SRC}" ]; then
            cp "${LIB_SRC}" "${OUT_DIR}/$(basename "${LIB_SRC}")"
            EXTRA="$(basename "${LIB_SRC}")"
          else
            EXTRA=""
          fi

          if [ -n "${EXTRA}" ]; then
            tar -czf "${OUT_DIR}/${ARTIFACT_BASE}.tar.gz" -C "${OUT_DIR}" "${ARTIFACT_BASE}${{ matrix.bin_ext }}" "${EXTRA}"
          else
            tar -czf "${OUT_DIR}/${ARTIFACT_BASE}.tar.gz" -C "${OUT_DIR}" "${ARTIFACT_BASE}${{ matrix.bin_ext }}"
          fi
          echo "asset=${OUT_DIR}/${ARTIFACT_BASE}.tar.gz" >> "$GITHUB_OUTPUT"

      - name: Package artifact (Windows)
        if: matrix.os_id == 'windows'
        id: package-win
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $artifactBase = "quick-${{ matrix.os_id }}-${{ matrix.arch }}"
          $targetDir = Join-Path $env:GITHUB_WORKSPACE "target/${{ matrix.target }}/release"
          $outDir = Join-Path $env:GITHUB_WORKSPACE "dist/${{ matrix.name }}"
          New-Item -ItemType Directory -Force -Path $outDir | Out-Null

          $binSrc = Join-Path $targetDir "quick${{ matrix.bin_ext }}"
          Copy-Item $binSrc (Join-Path $outDir "$artifactBase${{ matrix.bin_ext }}")

          $libSrc = Get-ChildItem -Path $targetDir -Filter "libquick.*" -ErrorAction SilentlyContinue | Select-Object -First 1
          if (-not $libSrc) {
            $libSrc = Get-ChildItem -Path $targetDir -Filter "quick.*" -ErrorAction SilentlyContinue | Select-Object -First 1
          }

          $entries = @((Join-Path $outDir "$artifactBase${{ matrix.bin_ext }}"))
          if ($libSrc) {
            Copy-Item $libSrc.FullName (Join-Path $outDir $libSrc.Name)
            $entries += (Join-Path $outDir $libSrc.Name)
          }

          $zipPath = Join-Path $outDir "$artifactBase.zip"
          Compress-Archive -Path $entries -DestinationPath $zipPath -Force
          "asset=$zipPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.name }}
          path: ${{ steps.package-unix.outputs.asset || steps.package-win.outputs.asset }}

      - name: Publish release asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.VERSION }}
          name: v${{ env.VERSION }}
          files: ${{ steps.package-unix.outputs.asset || steps.package-win.outputs.asset }}
          fail_on_unmatched_files: true
